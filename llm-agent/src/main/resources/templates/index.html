<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>LLM 流程编排器 (V3.0 - 数据库持久化)</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">
    <div class="preview-pane">
        <div class="status-panel">
            <div class="panel-header">
                <h2>流程状态</h2>
                <div class="header-buttons">
                    <button id="reset-btn" title="清空会话并重置流程">重置
                        会话</button>
                </div>
            </div>
            <ul id="process-status-list">
                <li th:each="entry : ${initialState.processStatus}">
                    <span th:class="${entry.value == 'COMPLETED' ? 'status-completed' : 'status-pending'}"></span>
                    <span th:text="${entry.key}"></span>
                </li>
            </ul>
        </div>
        <div class="persona-panel">
            <h2>当前人设 (预览)</h2>
            <p id="persona-display" th:text="${initialState.persona}"></p>
        </div>
    </div>

    <div class="chat-pane">
        <div id="system-prompt" class="system-prompt-container">
            <p>配置已从数据库加载，可以开始对话了。</p>
        </div>
        <div class="chat-window" id="chat-window">
            <div class="message bot-message"
                 th:if="${initialState.openingMonologue != null and !initialState.openingMonologue.isEmpty()}">
                <p th:text="${initialState.openingMonologue}"></p>
            </div>
        </div>

        <div id="decision-process-container" class="dp-fixed-container"></div>

        <div class="chat-input-area">
            <textarea id="user-input" placeholder="输入用户的回应..." rows="3"></textarea>
            <button id="send-btn">发送</button>
        </div>
    </div>

    <div class="config-pane">
        <div class="config-panel">

            <div class="tab-container">
                <button class="tab-button active" data-tab="workflow-tab">工作流</button>
                <button class="tab-button" data-tab="models-tab">模型</button>
                <button class="tab-button" data-tab="strategies-tab">策略</button>
            </div>

            <div id="workflow-tab" class="tab-content active">
                <label for="processes-input">流程步骤 (每行一个, *结尾代表可重复)</label>
                <textarea id="processes-input" rows="5"></textarea>

                <label for="dependencies-input"> 依赖规则 (例如: "2 -> 1") </label>
                <textarea id="dependencies-input" rows="3"></textarea>

                <label for="opening-monologue-input">模型开场白</label>
                <textarea id="opening-monologue-input" rows="3"></textarea>

                <label for="persona-template-input">主模型人设 (使用 {tasks}, {workflow}, {code})</label>
                <textarea id="persona-template-input" rows="10"></textarea>

                <label for="safety-redlines-input">沟通安全红线 (每行一个禁忌词)</label>
                <textarea id="safety-redlines-input" rows="4" placeholder="例如: 我保证, 肯定没问题, 百分之百"></textarea>

                <button id="save-workflow-btn" class="add-strategy-btn" style="width: 100%; margin-top: 15px;">保存工作流配置 (实时生效)</button>
            </div>

            <div id="models-tab" class="tab-content">
                <div class="model-config-section" id="main-model-config">
                    <h3>主模型 (Main Model)</h3>
                    <label for="main-model-name-input">模型名称</label>
                    <select id="main-model-name-input" class="model-select-list"></select>
                    <div class="slider-container">
                        <label>温度: <span id="main-temperature-value">0.7</span></label>
                        <input type="range" id="main-temperature-input" min="0" max="2" step="0.1" value="0.7">
                    </div>
                    <div class="slider-container">
                        <label>Top P: <span id="main-top-p-value">0.8</span></label>
                        <input type="range" id="main-top-p-input" min="0.1" max="1" step="0.1" value="0.8">
                    </div>
                    <label for="main-max-tokens-input" style="margin-top: 15px;">最大Token</label>
                    <input type="number" id="main-max-tokens-input" placeholder="例如: 2048">
                    <button id="save-main-model-btn" class="add-strategy-btn">保存主模型配置 (实时生效)</button>
                </div>

                <div class="model-config-section" id="pre-model-config">
                    <h3>预处理模型 (Pre-processing Model)</h3>
                    <label for="pre-model-name-input">模型名称</label>
                    <select id="pre-model-name-input" class="model-select-list"></select>
                    <div class="slider-container">
                        <label>温度: <span id="pre-temperature-value">0.1</span></label>
                        <input type="range" id="pre-temperature-input" min="0" max="2" step="0.1" value="0.1">
                    </div>
                    <div class="slider-container">
                        <label>Top P: <span id="pre-top-p-value">0.7</span></label>
                        <input type="range" id="pre-top-p-input" min="0.1" max="1" step="0.1" value="0.7">
                    </div>
                    <label for="pre-max-tokens-input" style="margin-top: 15px;">最大Token</label>
                    <input type="number" id="pre-max-tokens-input" placeholder="例如: 512">
                    <button id="save-pre-model-btn" class="add-strategy-btn">保存预处理模型 (实时生效)</button>
                </div>
            </div>

            <div id="strategies-tab" class="tab-content">

                <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                    <input type="checkbox" id="enable-strategy-input" style="vertical-align: middle;">
                    <label for="enable-strategy-input" style="display: inline; font-weight: bold; vertical-align: middle; margin-left: 5px;">启用策略/预处理系统</label>
                    <small style="display: block; margin-top: 5px; color: #6c757d;">(关闭后，所有意图分析、工具和策略都将跳过)</small>
                </div>

                <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                    <input type="checkbox" id="enable-emotion-input" style="vertical-align: middle;">
                    <label for="enable-emotion-input" style="display: inline; font-weight: bold; vertical-align: middle; margin-left: 5px;">启用情绪识别</label>
                    <small style="display: block; margin-top: 5px; color: #6c757d;">(关闭后，预处理将只分析意图和敏感词)</small>
                </div>

                <label for="pre-processing-prompt-input">预处理Prompt (小模型人设)</label>
                <textarea id="pre-processing-prompt-input" rows="8"></textarea>
                <button id="save-pre-prompt-btn" class="add-strategy-btn">保存Prompt (实时生效)</button>

                <h2 class="section-header">🛠️ 工具/MCP 配置</h2>
                <div id="tools-config-list" class="strategy-list" style="flex-direction: column; gap: 12px;">
                </div>

                <h2 class="section-header">决策规则库 (何时出牌?)</h2>
                <div id="decision-rules-container">
                    <table class="rules-table">
                        <thead>
                        <tr>
                            <th>优先级</th>
                            <th>触发意图</th>
                            <th>触发情绪 (选填)</th>
                            <th>策略键 (话术卡牌)</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody id="decision-rules-tbody">
                        </tbody>
                    </table>
                </div>
                <button id="add-decision-rule-btn" class="add-strategy-btn">+ 添加新规则</button>

                <h2 class="section-header">兜底回复</h2>
                <label for="sensitive-response-input">检测到敏感词时</label>
                <input type="text" id="sensitive-response-input">
                <button id="save-fallback-btn" class="add-strategy-btn" style="width: 100%; margin-top: 15px;">保存兜底回复 (实时生效)</button>
            </div>

        </div>
    </div>
</div>
<script th:src="@{/js/script.js}"></script>
</body>
</html>